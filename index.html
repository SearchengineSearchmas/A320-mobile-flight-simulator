<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A320 Extreme Flight Sim</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ff00; pointer-events: none; z-index: 10; }
        
        /* Joystick Styles */
        #joy-container { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 50%; display: none; touch-action: none; }
        #joy-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.6; }
        @media (pointer: coarse) { #joy-container { display: block; } }

        /* Crash Overlay */
        #crash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 100; background: rgba(50, 0, 0, 0.4); }
        #blood-canvas { width: 100%; height: 100%; }
        #warning { position: absolute; top: 40%; width: 100%; text-align: center; color: #ff0000; font-size: 3rem; font-weight: bold; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-size: 1.2rem; margin-bottom: 5px;">AIRBUS A320 NEO</div>
    <div id="stats">ALT: 1500FT | SPD: 240KTS</div>
</div>

<div id="joy-container"><div id="joy-knob"></div></div>

<div id="crash-screen">
    <div id="warning">TERRAIN COLLISION - SIGNAL LOST</div>
    <canvas id="blood-canvas"></canvas>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- Scene Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x6aaed6);
    scene.fog = new THREE.FogExp2(0x6aaed6, 0.00015);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 30000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1.5);
    light.position.set(500, 1000, 500);
    scene.add(light, new THREE.AmbientLight(0xffffff, 0.5));

    // --- Objects & Groups ---
    const collidables = [];
    const npcs = [];
    let isCrashed = false;

    // Ground
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(50000, 50000), 
        new THREE.MeshStandardMaterial({ color: 0x223311 })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // City Buildings
    const buildGeo = new THREE.BoxGeometry(40, 200, 40);
    const buildMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
    for(let i=0; i<40; i++) {
        const b = new THREE.Mesh(buildGeo, buildMat);
        b.position.set(Math.random()*2000-1000, 100, Math.random()*-4000-500);
        scene.add(b);
        collidables.push(b);
    }

    // AI NPC Planes (Red Gliders)
    function createNPC() {
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(2, 10, 4, 8), new THREE.MeshStandardMaterial({color:0x990000}));
        body.rotation.x = Math.PI/2;
        const wing = new THREE.Mesh(new THREE.BoxGeometry(15, 0.5, 3), new THREE.MeshStandardMaterial({color:0xff0000}));
        group.add(body, wing);
        group.position.set(Math.random()*600-300, Math.random()*300+100, Math.random()*-3000);
        scene.add(group);
        npcs.push(group);
        collidables.push(group);
    }
    for(let i=0; i<8; i++) createNPC();

    // A320 Cockpit Frame
    const cockpit = new THREE.Group();
    const glassFrameMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a });
    const dash = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 2), glassFrameMat);
    dash.position.set(0, -0.8, -1);
    const pillarL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 0.2), glassFrameMat);
    pillarL.position.set(-1.2, 0, -0.5); pillarL.rotation.z = 0.3;
    const pillarR = pillarL.clone(); pillarR.position.x = 1.2; pillarR.rotation.z = -0.3;
    cockpit.add(dash, pillarL, pillarR);
    camera.add(cockpit);
    scene.add(camera);
    camera.position.y = 500; // Start at altitude

    // --- Controls ---
    const keys = { up: false, down: false, left: false, right: false };
    const joy = { x: 0, y: 0 };
    window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key.replace('Arrow','').toLowerCase())) keys[e.key.replace('Arrow','').toLowerCase()] = true; });
    window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key.replace('Arrow','').toLowerCase())) keys[e.key.replace('Arrow','').toLowerCase()] = false; });

    // Mobile Joystick
    const joyCont = document.getElementById('joy-container');
    const joyKnob = document.getElementById('joy-knob');
    joyCont.addEventListener('touchmove', e => {
        const r = joyCont.getBoundingClientRect();
        const t = e.touches[0];
        joy.x = (t.clientX - (r.left + r.width/2)) / (r.width/2);
        joy.y = (t.clientY - (r.top + r.height/2)) / (r.height/2);
        joyKnob.style.left = `${50 + Math.max(-50, Math.min(50, joy.x * 50))}%`;
        joyKnob.style.top = `${50 + Math.max(-50, Math.min(50, joy.y * 50))}%`;
    });
    joyCont.addEventListener('touchend', () => { joy.x = 0; joy.y = 0; joyKnob.style.left='50%'; joyKnob.style.top='50%'; });

    // --- Crash Cutscene ---
    function triggerCrash() {
        if(isCrashed) return;
        isCrashed = true;
        document.getElementById('crash-screen').style.display = 'block';
        const canvas = document.getElementById('blood-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const drips = [];
        for(let i=0; i<40; i++) drips.push({x: Math.random()*canvas.width, y: -20, r: Math.random()*20+10, s: Math.random()*4+2});

        function drip() {
            ctx.fillStyle = 'rgba(150, 0, 0, 0.7)';
            drips.forEach(d => {
                ctx.beginPath();
                ctx.arc(d.x, d.y, d.r, 0, Math.PI*2);
                ctx.fill();
                d.y += d.s;
                d.x += Math.sin(d.y/20);
            });
            if(isCrashed) requestAnimationFrame(drip);
        }
        drip();
        setTimeout(() => location.reload(), 5000);
    }

    // --- Game Loop ---
    let speed = 3.5;
    function animate() {
        if(isCrashed) return;
        requestAnimationFrame(animate);

        // Movement Logic
        let pitch = 0, roll = 0;
        // PC: Down=Up, Up=Down | Mobile: Joy.y
        if(keys.up || joy.y < -0.2) pitch = -0.015;
        if(keys.down || joy.y > 0.2) pitch = 0.015;
        if(keys.left || joy.x < -0.2) roll = 0.025;
        if(keys.right || joy.x > 0.2) roll = -0.025;

        camera.rotation.x += pitch;
        camera.rotation.z = THREE.MathUtils.lerp(camera.rotation.z, roll*2, 0.1);
        camera.rotation.y += roll * 0.6;
        camera.translateZ(-speed);

        // NPC AI Logic
        npcs.forEach(n => {
            n.position.z += 1.5; // Flying towards you
            if(n.position.z > camera.position.z + 100) n.position.z -= 4000;
        });

        // Collision Checks
        if(camera.position.y < 5) triggerCrash(); // Ground
        collidables.forEach(c => {
            if(camera.position.distanceTo(c.position) < 25) triggerCrash();
        });

        document.getElementById('stats').innerText = `ALT: ${Math.round(camera.position.y * 3)}FT | SPD: 240KTS`;
        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
