<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>A320 Legacy Engine - IE Friendly</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #0f0; font-family: "Courier New", Courier, monospace; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 5; }
        #crash-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; background: #600; filter: alpha(opacity=50); /* IE8-11 Alpha */
            opacity: 0.5; z-index: 10; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="ui">
    <div>A320 LEGACY ENGINE (ES5)</div>
    <div id="alt-meter">ALT: 1000</div>
</div>

<div id="crash-overlay">
    <div style="color:white; text-align:center; padding-top:20%; font-size:30px; font-weight:bold;">
        SYSTEM FAILURE - COLLISION
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- Compatibility Check & Polyfills ---
    var canvas = document.getElementById('gameCanvas');
    var ctx = canvas.getContext('2d');
    var width, height;
    
    // --- Flight State (Using var for IE11) ---
    var camX = 0;
    var camY = 150;
    var camZ = 0;
    var pitch = 0;
    var roll = 0;
    var speed = 12;
    var isCrashed = false;
    
    var buildings = [];
    var npcs = [];

    // --- Setup Functions ---
    function init() {
        resize();
        for (var i = 0; i < 60; i++) {
            buildings.push({
                x: (Math.random() * 4000) - 2000,
                y: 0,
                z: (Math.random() * -10000),
                h: (Math.random() * 400) + 100,
                w: 60
            });
        }
        for (var j = 0; j < 5; j++) {
            npcs.push({ x: (Math.random() * 1000) - 500, y: 300, z: (Math.random() * -5000) });
        }
        loop();
    }

    function resize() {
        width = canvas.width = window.innerWidth || document.documentElement.clientWidth;
        height = canvas.height = window.innerHeight || document.documentElement.clientHeight;
    }

    // --- ES5 3D Projection ---
    function project(x, y, z) {
        var tx = x - camX;
        var ty = y - camY;
        var tz = z - camZ;

        // Roll
        var cosR = Math.cos(roll);
        var sinR = Math.sin(roll);
        var rx = tx * cosR - ty * sinR;
        var ry = tx * sinR + ty * cosR;

        // Pitch
        var cosP = Math.cos(pitch);
        var sinP = Math.sin(pitch);
        var finalY = ry * cosP - tz * sinP;
        var finalZ = ry * sinP + tz * cosP;

        if (finalZ >= 0) return null;

        var focalLength = 600;
        var scale = focalLength / -finalZ;
        
        return {
            x: (width / 2) + rx * scale,
            y: (height / 2) + finalY * scale,
            size: scale
        };
    }

    // --- Controls (Legacy Events) ---
    var keys = {};
    window.onkeydown = function(e) { keys[e.keyCode] = true; };
    window.onkeyup = function(e) { keys[e.keyCode] = false; };

    function handleCrash() {
        if (isCrashed) return;
        isCrashed = true;
        document.getElementById('crash-overlay').style.display = 'block';
        setTimeout(function() { window.location.reload(); }, 3000);
    }

    // --- Game Logic ---
    function update() {
        if (isCrashed) return;

        // IE keyCode Mapping: 38=Up, 40=Down, 37=Left, 39=Right
        if (keys[40]) pitch += 0.02;
        if (keys[38]) pitch -= 0.02;
        if (keys[37]) roll -= 0.04;
        if (keys[39]) roll += 0.04;

        pitch *= 0.98;
        roll *= 0.95;

        camZ -= speed * Math.cos(pitch);
        camY -= speed * Math.sin(pitch);
        camX += speed * Math.sin(roll);

        for (var i = 0; i < buildings.length; i++) {
            var b = buildings[i];
            if (b.z > camZ + 1000) {
                b.z -= 10000;
                b.x = camX + (Math.random() * 4000 - 2000);
            }
            // Collision
            if (Math.abs(camX - b.x) < 50 && camY < b.h && Math.abs(camZ - b.z) < 50) handleCrash();
        }

        if (camY < 10) handleCrash();
        document.getElementById('alt-meter').innerHTML = "ALT: " + Math.round(camY);
    }

    function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, width, height);

        // Grid/Ground for movement sense
        ctx.strokeStyle = "#030";
        ctx.lineWidth = 1;
        
        // Buildings
        ctx.strokeStyle = "#0f0";
        for (var i = 0; i < buildings.length; i++) {
            var b = buildings[i];
            var p1 = project(b.x - b.w, 0, b.z);
            var p2 = project(b.x + b.w, b.h, b.z);
            
            if (p1 && p2) {
                ctx.strokeRect(p1.x, p2.y, p2.x - p1.x, p1.y - p2.y);
            }
        }

        // NPCs
        ctx.strokeStyle = "#f00";
        for (var j = 0; j < npcs.length; j++) {
            var n = npcs[j];
            n.z += 5;
            if (n.z > camZ + 500) n.z -= 5000;
            var p = project(n.x, n.y, n.z);
            if (p) {
                ctx.beginPath();
                ctx.moveTo(p.x - (15 * p.size), p.y);
                ctx.lineTo(p.x + (15 * p.size), p.y);
                ctx.stroke();
            }
        }

        // Static Cockpit
        ctx.strokeStyle = "#444";
        ctx.lineWidth = 4;
        ctx.strokeRect(width * 0.15, height * 0.75, width * 0.7, height * 0.3);
        ctx.beginPath();
        ctx.moveTo(width/2, height*0.2);
        ctx.lineTo(width/2, height*0.75);
        ctx.stroke();
    }

    function loop() {
        update();
        draw();
        // IE11 supports requestAnimationFrame, older versions need polyfill
        window.requestAnimationFrame ? window.requestAnimationFrame(loop) : setTimeout(loop, 16);
    }

    window.onresize = resize;
    init();
</script>
</body>
</html>
