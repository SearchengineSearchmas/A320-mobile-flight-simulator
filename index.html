<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A320 Ultra Pro Sim</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* Tactical HUD - Top Right */
        #flight-data {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.6); color: #00ff00;
            padding: 15px; border-radius: 8px; border: 1px solid #00ff00;
            font-family: monospace; text-align: right; z-index: 100;
        }

        /* Mobile Joystick */
        #joy-base {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px; background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            touch-action: none; z-index: 100; display: none;
        }
        #joy-stick {
            position: absolute; top: 50%; left: 50%; width: 45px; height: 45px;
            background: #fff; border-radius: 50%; transform: translate(-50%, -50%);
            opacity: 0.6; box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        @media (pointer: coarse) { #joy-base { display: block; } }

        #view-btn {
            position: absolute; bottom: 30px; right: 30px;
            padding: 12px 20px; background: #222; color: white;
            border: 2px solid #555; border-radius: 5px; cursor: pointer;
        }

        #crash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; z-index: 1000; background: rgba(100, 0, 0, 0.4);
        }
    </style>
</head>
<body>

<div id="flight-data">
    <div>SPD: <span id="spd-val">250</span> KTS</div>
    <div>ALT: <span id="alt-val">1500</span> FT</div>
    <div>VS: <span id="vs-val">0</span> FPM</div>
</div>

<button id="view-btn">SWITCH VIEW (V)</button>
<div id="joy-base"><div id="joy-stick"></div></div>

<div id="crash-screen">
    <canvas id="blood-canvas"></canvas>
    <div style="position:absolute; top:45%; width:100%; text-align:center; color:white; font-size:3rem; font-weight:bold;">PULL UP!</div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- Scene Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x00050a);
    scene.fog = new THREE.FogExp2(0x00050a, 0.0001);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ReinhardToneMapping;
    document.body.appendChild(renderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 0.2);
    const moonLight = new THREE.DirectionalLight(0x5555ff, 1.5);
    moonLight.position.set(500, 1000, 500);
    scene.add(ambient, moonLight);

    // --- Assets ---
    const buildings = [];
    const citySize = 15000;

    // Realistic Procedural City
    function createCity() {
        const box = new THREE.BoxGeometry(1, 1, 1);
        for(let i=0; i<500; i++) {
            const h = Math.random() * 400 + 50;
            const w = Math.random() * 50 + 30;
            const mat = new THREE.MeshStandardMaterial({ 
                color: 0x111111,
                emissive: 0x000000 
            });
            const b = new THREE.Mesh(box, mat);
            b.scale.set(w, h, w);
            b.position.set(Math.random()*8000-4000, h/2, Math.random()*-citySize);
            
            // Add Window Lights
            const winGeo = new THREE.BoxGeometry(w+1, 2, w+1);
            const winMat = new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffff00, emissiveIntensity: 2 });
            for(let j=0; j<2; j++) {
                const wLight = new THREE.Mesh(winGeo, winMat);
                wLight.position.y = (Math.random()*h) - h/2;
                b.add(wLight);
            }
            scene.add(b);
            buildings.push(b);
        }
    }
    createCity();

    // --- A320 Aircraft Group ---
    const planeGroup = new THREE.Group();
    const fuselage = new THREE.Mesh(new THREE.CapsuleGeometry(4, 35, 4, 16), new THREE.MeshStandardMaterial({color: 0xeeeeee}));
    fuselage.rotation.x = Math.PI/2;
    planeGroup.add(fuselage);
    
    // Cockpit Internals
    const cockpit = new THREE.Group();
    const stick = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 3), new THREE.MeshStandardMaterial({color: 0x111111}));
    stick.position.set(-3.5, -1, 5);
    cockpit.add(stick);
    planeGroup.add(cockpit);

    scene.add(planeGroup);
    planeGroup.position.y = 800;

    // --- Physics & Control ---
    let isThirdPerson = false;
    let isDead = false;
    const input = { p: 0, r: 0 };
    const keys = { arrowup: false, arrowdown: false, arrowleft: false, arrowright: false };

    window.addEventListener('keydown', e => { 
        if(e.key.toLowerCase() === 'v') isThirdPerson = !isThirdPerson;
        keys[e.key.toLowerCase()] = true; 
    });
    window.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

    // Joystick Logic
    const joyBase = document.getElementById('joy-base');
    const joyStick = document.getElementById('joy-stick');
    joyBase.addEventListener('touchmove', e => {
        const r = joyBase.getBoundingClientRect();
        const t = e.touches[0];
        input.r = -((t.clientX - (r.left + r.width/2)) / (r.width/2)) * 0.05;
        input.p = ((t.clientY - (r.top + r.height/2)) / (r.height/2)) * 0.04;
        joyStick.style.left = `${50 - input.r*1000}%`;
        joyStick.style.top = `${50 + input.p*1200}%`;
    });
    joyBase.addEventListener('touchend', () => { input.p = 0; input.r = 0; joyStick.style.left='50%'; joyStick.style.top='50%'; });

    function crash() {
        if(isDead) return;
        isDead = true;
        document.getElementById('crash-screen').style.display = 'block';
        const canvas = document.getElementById('blood-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let blood = [];
        for(let i=0; i<60; i++) blood.push({x:Math.random()*canvas.width, y:-20, r:Math.random()*25+5, s:Math.random()*6+2});
        function animateBlood() {
            ctx.fillStyle = 'rgba(180,0,0,0.6)';
            blood.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); b.y+=b.s; });
            requestAnimationFrame(animateBlood);
        }
        animateBlood();
        setTimeout(() => location.reload(), 3500);
    }

    function animate() {
        if(isDead) return;
        requestAnimationFrame(animate);

        // Movement Logic
        if(keys.arrowdown) input.p = 0.025; // Pull Up
        if(keys.arrowup) input.p = -0.025;
        if(keys.arrowleft) input.r = 0.04;
        if(keys.arrowright) input.r = -0.04;

        if(!keys.arrowup && !keys.arrowdown && joyBase.style.display === 'none') input.p *= 0.9;
        if(!keys.arrowleft && !keys.arrowright && joyBase.style.display === 'none') input.r *= 0.9;

        planeGroup.rotation.x += input.p;
        planeGroup.rotation.y += input.r * 0.5;
        planeGroup.rotation.z = THREE.MathUtils.lerp(planeGroup.rotation.z, input.r * 2.5, 0.1);
        planeGroup.translateZ(-10);

        // Sidestick tilt
        stick.rotation.x = input.p * 15;
        stick.rotation.z = input.r * 15;

        // Camera Logic
        if(isThirdPerson) {
            const camOffset = new THREE.Vector3(0, 20, 70).applyQuaternion(planeGroup.quaternion);
            camera.position.copy(planeGroup.position).add(camOffset);
            camera.lookAt(planeGroup.position);
            cockpit.visible = false;
        } else {
            camera.position.copy(planeGroup.position);
            camera.quaternion.copy(planeGroup.quaternion);
            cockpit.visible = true;
        }

        // Infinite World Recycling
        buildings.forEach(b => {
            if(b.position.z > planeGroup.position.z + 1000) {
                b.position.z -= citySize;
                b.position.x = planeGroup.position.x + (Math.random()*6000-3000);
            }
            if(planeGroup.position.distanceTo(b.position) < 45) crash();
        });

        if(planeGroup.position.y < 10) crash();

        // UI Updates
        document.getElementById('alt-val').innerText = Math.round(planeGroup.position.y * 3.2);
        document.getElementById('vs-val').innerText = Math.round(input.p * -5000);
        
        renderer.render(scene, camera);
    }

    window.onresize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };

    animate();
</script>
</body>
</html>
